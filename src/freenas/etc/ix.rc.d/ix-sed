#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: ix-sed
# BEFORE: ix-fstab

. /etc/rc.subr

unlock_drives()
{
	# This block inserts data into the disk_passwd column that
	# was saved out of the database prior to running storage/0009
	# migration.
	# This would only be needed if you manually added disk_passwd
	# to the database in a version of FreeNAS prior to 11.2-R
	# and wanted the data to be preserved when the migration ran.
	if [ -f /data/seddata ]; then
		# We are running very early, make / read-write.
		mount -uw /
		for i in `cat /data/seddata`
		do
			dn=$(echo $i | awk -F\| '{print $1}')
			dp=$(echo $i | awk -F\| '{print $2}')
                        ${FREENAS_SQLITE_CMD} ${FREENAS_CONFIG} "UPDATE storage_disk SET disk_passwd = \"${dp}\" WHERE disk_name = \"${dn}\" "
		done
		sync
		sync
		sleep 3
		rm /data/seddata
	fi
	local IFS="|"
	local f="disk_passwd"
	local g="disk_name"
	eval local $f
	eval local $g
	local sf=$(var_to_sf $f)
	local sg=$(var_to_sf $g)
	RO_FREENAS_CONFIG=$(ro_sqlite ${name} 2> /tmp/${name}.fail && rm /tmp/${name}.fail)
	local user=$(${FREENAS_SQLITE_CMD} ${RO_FREENAS_CONFIG} "SELECT adv_sed_user FROM system_advanced")
	trap 'rm -f ${RO_FREENAS_CONFIG}' EXIT

	${FREENAS_SQLITE_CMD} ${RO_FREENAS_CONFIG} "
	SELECT
		$sg,$sf

	FROM
		storage_disk

	WHERE (
		$sf != ''
	)

	 " | \
	while eval read $g $f
	do
		ret=$(/sbin/camcontrol security /dev/${disk_name} | awk '$1 == "drive" {print $3}')
		if [ -n "${ret}" -a "${ret}" = "yes" ]; then
			echo -n "Unlocking ${disk_name}: "
			/sbin/camcontrol security /dev/${disk_name} -U ${user} -k "$(/usr/local/bin/midclt call notifier.pwenc_decrypt ${disk_passwd})" > /dev/null 2>&1
			if [ $? -eq 0 ]; then
				/usr/bin/true > /dev/${disk_name}
				echo "Success"
			else
				echo "Failed"
			fi
		else
			echo "Skipping ${disk_name}, already unlocked"
		fi
	done
}

name="ix-sed"
start_cmd='unlock_drives'
stop_cmd=':'

load_rc_config $name
run_rc_command "$1"
